import psycopg2
import json
from datetime import datetime
import sys

def setup_postgres_database():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏"""
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤–∞–º–∏)
    conn_params = {
        "dbname": "studpg",
        "user": "student", 
        "password": "Stud2024!!!",
        "host": "postgresql",
        "port": "5432"
    }
    
    try:
        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
        print("üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL...")
        conn = psycopg2.connect(**conn_params)
        print("‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL")
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        with open('data/01_generated_data.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –ø—Ä–∞–≤
        with conn.cursor() as cur:
            print("üóÉÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü...")
            
            # –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞)
            try:
                cur.execute("DROP TABLE IF EXISTS shipments CASCADE")
                cur.execute("DROP TABLE IF EXISTS routes CASCADE") 
                cur.execute("DROP TABLE IF EXISTS warehouses CASCADE")
                print("‚úÖ –°—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã —É–¥–∞–ª–µ–Ω—ã")
            except Exception as e:
                print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç–∞–±–ª–∏—Ü—ã: {e}")
                print("–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü...")
            
            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å–∫–ª–∞–¥–æ–≤
            try:
                cur.execute("""
                    CREATE TABLE warehouses (
                        id INTEGER PRIMARY KEY,
                        name VARCHAR(100),
                        city VARCHAR(50),
                        type VARCHAR(50),
                        capacity INTEGER,
                        employees INTEGER,
                        latitude DECIMAL(10,6),
                        longitude DECIMAL(10,6)
                    )
                """)
                print("‚úÖ –¢–∞–±–ª–∏—Ü–∞ warehouses —Å–æ–∑–¥–∞–Ω–∞")
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è warehouses: {e}")
                return None
            
            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤
            try:
                cur.execute("""
                    CREATE TABLE routes (
                        id INTEGER PRIMARY KEY,
                        name VARCHAR(100),
                        start_city VARCHAR(50),
                        end_city VARCHAR(50),
                        distance INTEGER,
                        duration_hours INTEGER,
                        transport_type VARCHAR(50),
                        status VARCHAR(50),
                        cost_per_km DECIMAL(10,2)
                    )
                """)
                print("‚úÖ –¢–∞–±–ª–∏—Ü–∞ routes —Å–æ–∑–¥–∞–Ω–∞")
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è routes: {e}")
                return None
            
            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≥—Ä—É–∑–æ–≤
            try:
                cur.execute("""
                    CREATE TABLE shipments (
                        id INTEGER PRIMARY KEY,
                        tracking_number VARCHAR(20) UNIQUE,
                        warehouse_from_id INTEGER,
                        warehouse_to_id INTEGER,
                        route_id INTEGER,
                        weight DECIMAL(10,2),
                        volume DECIMAL(10,2),
                        value DECIMAL(10,2),
                        shipment_date TIMESTAMP,
                        delivery_date TIMESTAMP,
                        status VARCHAR(50),
                        type VARCHAR(50),
                        priority VARCHAR(20)
                    )
                """)
                print("‚úÖ –¢–∞–±–ª–∏—Ü–∞ shipments —Å–æ–∑–¥–∞–Ω–∞")
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è shipments: {e}")
                return None
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        print("üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL...")
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–ª–∞–¥–æ–≤
        with conn.cursor() as cur:
            warehouses_count = 0
            for warehouse in data['warehouses']:
                try:
                    cur.execute("""
                        INSERT INTO warehouses (id, name, city, type, capacity, employees, latitude, longitude)
                        VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
                    """, (warehouse['id'], warehouse['name'], warehouse['city'], 
                          warehouse['type'], warehouse['capacity'], warehouse['employees'],
                          warehouse['latitude'], warehouse['longitude']))
                    warehouses_count += 1
                except Exception as e:
                    print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ —Å–∫–ª–∞–¥–∞ {warehouse['id']}: {e}")
        
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–∫–ª–∞–¥–æ–≤: {warehouses_count}")
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤
        with conn.cursor() as cur:
            routes_count = 0
            for route in data['routes']:
                try:
                    cur.execute("""
                        INSERT INTO routes (id, name, start_city, end_city, distance, duration_hours, 
                                         transport_type, status, cost_per_km)
                        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
                    """, (route['id'], route['name'], route['start_city'], route['end_city'],
                          route['distance'], route['duration_hours'], route['transport_type'],
                          route['status'], route['cost_per_km']))
                    routes_count += 1
                except Exception as e:
                    print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ {route['id']}: {e}")
        
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –º–∞—Ä—à—Ä—É—Ç–æ–≤: {routes_count}")
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–∑–æ–≤
        with conn.cursor() as cur:
            shipments_count = 0
            for shipment in data['shipments']:
                try:
                    cur.execute("""
                        INSERT INTO shipments (id, tracking_number, warehouse_from_id, warehouse_to_id, 
                                            route_id, weight, volume, value, shipment_date, 
                                            delivery_date, status, type, priority)
                        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                    """, (shipment['id'], shipment['tracking_number'], shipment['warehouse_from_id'],
                          shipment['warehouse_to_id'], shipment['route_id'], shipment['weight'],
                          shipment['volume'], shipment['value'], shipment['shipment_date'],
                          shipment['delivery_date'], shipment['status'], shipment['type'],
                          shipment['priority']))
                    shipments_count += 1
                except Exception as e:
                    print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –≥—Ä—É–∑–∞ {shipment['id']}: {e}")
        
        print(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –≥—Ä—É–∑–æ–≤: {shipments_count}")
        
        conn.commit()
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞)
        print("üîç –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤...")
        with conn.cursor() as cur:
            try:
                cur.execute("CREATE INDEX idx_shipments_tracking ON shipments(tracking_number)")
                print("‚úÖ –ò–Ω–¥–µ–∫—Å idx_shipments_tracking —Å–æ–∑–¥–∞–Ω")
            except Exception as e:
                print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å idx_shipments_tracking: {e}")
            
            try:
                cur.execute("CREATE INDEX idx_shipments_status ON shipments(status)")
                print("‚úÖ –ò–Ω–¥–µ–∫—Å idx_shipments_status —Å–æ–∑–¥–∞–Ω")
            except Exception as e:
                print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å idx_shipments_status: {e}")
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        with conn.cursor() as cur:
            try:
                cur.execute("SELECT pg_size_pretty(pg_database_size('studpg'))")
                db_size = cur.fetchone()[0]
                print(f"üíæ –†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {db_size}")
            except Exception as e:
                print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ë–î: {e}")
                db_size = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        postgres_metadata = {
            'setup_time': datetime.now().isoformat(),
            'connection_params': {
                'host': conn_params['host'],
                'database': conn_params['dbname'],
                'user': conn_params['user']
            },
            'tables_created': ['warehouses', 'routes', 'shipments'],
            'records_loaded': {
                'warehouses': warehouses_count,
                'routes': routes_count, 
                'shipments': shipments_count
            },
            'database_size': db_size,
            'status': 'success'
        }
        
        with open('data/02_postgres_metadata.json', 'w', encoding='utf-8') as f:
            json.dump(postgres_metadata, f, ensure_ascii=False, indent=2)
        
        print("‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ data/02_postgres_metadata.json")
        
        conn.close()
        return postgres_metadata
        
    except psycopg2.OperationalError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL: {e}")
        print("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:")
        print("   - –ó–∞–ø—É—â–µ–Ω –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä PostgreSQL: docker compose ps")
        print("   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è")
        print("   - –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ö–æ—Å—Ç–∞ 'postgresql' –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞")
        return None
    except Exception as e:
        print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        return None

if __name__ == "__main__":
    setup_postgres_database()
