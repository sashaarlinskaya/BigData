import psycopg2
from pymongo import MongoClient
import time
import json
from datetime import datetime
import matplotlib.pyplot as plt
import numpy as np
import seaborn as sns

def check_mongo_connection():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π"""
    connection_strings = [
        'mongodb://localhost:27017/',  # –ë–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        'mongodb://mongouser:mongopass@localhost:27017/',
        'mongodb://mongodb:27017/',  # –ò–º—è —Å–µ—Ä–≤–∏—Å–∞ –≤ Docker
        'mongodb://mongouser:mongopass@mongodb:27017/'
    ]
    
    for conn_str in connection_strings:
        try:
            print(f"üîç –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {conn_str}")
            client = MongoClient(conn_str, serverSelectionTimeoutMS=5000)
            client.server_info()  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: {conn_str}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            db_list = client.list_database_names()
            print(f"üìÅ –î–æ—Å—Ç—É–ø–Ω—ã–µ –±–∞–∑—ã: {db_list}")
            
            if 'studmongo' in db_list:
                print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö studmongo –Ω–∞–π–¥–µ–Ω–∞")
                db = client['studmongo']
                collections = db.list_collection_names()
                print(f"üìä –ö–æ–ª–ª–µ–∫—Ü–∏–∏ –≤ studmongo: {collections}")
                
                if 'shipments' in collections:
                    count = db.shipments.count_documents({})
                    print(f"‚úÖ –ö–æ–ª–ª–µ–∫—Ü–∏—è shipments –Ω–∞–π–¥–µ–Ω–∞, –∑–∞–ø–∏—Å–µ–π: {count}")
                    client.close()
                    return True
                else:
                    print("‚ùå –ö–æ–ª–ª–µ–∫—Ü–∏—è shipments –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            else:
                print("‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö studmongo –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
                
            client.close()
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è {conn_str}: {e}")
            continue
    
    return False

def get_mongo_client():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB"""
    # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
    connection_strings = [
        'mongodb://localhost:27017/',
        'mongodb://mongouser:mongopass@localhost:27017/',
        'mongodb://mongodb:27017/',
        'mongodb://mongouser:mongopass@mongodb:27017/'
    ]
    
    for conn_str in connection_strings:
        try:
            print(f"  üîó –ü–æ–ø—ã—Ç–∫–∞: {conn_str}")
            client = MongoClient(conn_str, serverSelectionTimeoutMS=5000)
            client.server_info()
            print(f"  ‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: {conn_str}")
            return client
        except Exception as e:
            print(f"  ‚ùå –û—à–∏–±–∫–∞: {e}")
            continue
    
    return None

def measure_time(func, *args, **kwargs):
    """–ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏"""
    start_time = time.time()
    result = func(*args, **kwargs)
    end_time = time.time()
    return result, end_time - start_time

def get_postgres_shipments_by_status(status):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä—É–∑–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É –≤ PostgreSQL"""
    # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (host –æ—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ postgresql)
    conn_params = {
        "dbname": "studpg",
        "user": "postgres",  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å student –Ω–∞ postgres
        "password": "changeme",  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å Stud2024!!! –Ω–∞ changeme
        "host": "postgresql",  # –û—Å—Ç–∞–≤–ª–µ–Ω–æ –∫–∞–∫ postgresql
        "port": "5432"
    }
    
    try:
        conn = psycopg2.connect(**conn_params)
        with conn.cursor() as cur:
            cur.execute("""
                SELECT s.tracking_number, s.status, s.weight, s.value,
                       wf.name as from_warehouse, wt.name as to_warehouse,
                       r.name as route_name
                FROM shipments s
                JOIN warehouses wf ON s.warehouse_from_id = wf.id
                JOIN warehouses wt ON s.warehouse_to_id = wt.id
                JOIN routes r ON s.route_id = r.id
                WHERE s.status = %s
                ORDER BY s.shipment_date DESC
                LIMIT 100
            """, (status,))
            results = cur.fetchall()
            print(f"  ‚úÖ PostgreSQL –Ω–∞–π–¥–µ–Ω–æ: {len(results)} –∑–∞–ø–∏—Å–µ–π")
            return results
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ PostgreSQL: {e}")
        return []
    finally:
        if 'conn' in locals():
            conn.close()

def get_mongodb_shipments_by_status(status):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä—É–∑–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É –≤ MongoDB"""
    mongo_client = get_mongo_client()
    if not mongo_client:
        print("  ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MongoDB")
        return []
    
    try:
        db = mongo_client['studmongo']
        results = list(db.shipments.find(
            {"status": status},
            {
                "tracking_number": 1,
                "status": 1,
                "weight": 1,
                "value": 1,
                "warehouse_from.name": 1,
                "warehouse_to.name": 1,
                "route.name": 1,
                "shipment_date": 1
            }
        ).sort("shipment_date", -1).limit(100))
        print(f"  ‚úÖ MongoDB –Ω–∞–π–¥–µ–Ω–æ: {len(results)} –∑–∞–ø–∏—Å–µ–π")
        return results
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ MongoDB –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: {e}")
        return []
    finally:
        mongo_client.close()

def get_postgres_heavy_shipments(weight_threshold):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—è–∂–µ–ª—ã—Ö –≥—Ä—É–∑–æ–≤ –≤ PostgreSQL"""
    conn_params = {
        "dbname": "studpg",
        "user": "postgres",  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
        "password": "changeme",  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
        "host": "postgresql",  # –û—Å—Ç–∞–≤–ª–µ–Ω–æ –∫–∞–∫ postgresql
        "port": "5432"
    }
    
    try:
        conn = psycopg2.connect(**conn_params)
        with conn.cursor() as cur:
            cur.execute("""
                SELECT s.tracking_number, s.weight, s.value, wf.city, wt.city, r.distance
                FROM shipments s
                JOIN warehouses wf ON s.warehouse_from_id = wf.id
                JOIN warehouses wt ON s.warehouse_to_id = wt.id  
                JOIN routes r ON s.route_id = r.id
                WHERE s.weight > %s
                ORDER BY s.weight DESC
                LIMIT 100
            """, (weight_threshold,))
            results = cur.fetchall()
            print(f"  ‚úÖ PostgreSQL –Ω–∞–π–¥–µ–Ω–æ: {len(results)} –∑–∞–ø–∏—Å–µ–π")
            return results
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ PostgreSQL: {e}")
        return []
    finally:
        if 'conn' in locals():
            conn.close()

def get_mongodb_heavy_shipments(weight_threshold):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—è–∂–µ–ª—ã—Ö –≥—Ä—É–∑–æ–≤ –≤ MongoDB"""
    mongo_client = get_mongo_client()
    if not mongo_client:
        print("  ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MongoDB")
        return []
    
    try:
        db = mongo_client['studmongo']
        results = list(db.shipments.find(
            {"weight": {"$gt": weight_threshold}},
            {
                "tracking_number": 1,
                "weight": 1,
                "value": 1,
                "warehouse_from.city": 1,
                "warehouse_to.city": 1,
                "route.distance": 1
            }
        ).sort("weight", -1).limit(100))
        print(f"  ‚úÖ MongoDB –Ω–∞–π–¥–µ–Ω–æ: {len(results)} –∑–∞–ø–∏—Å–µ–π")
        return results
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ MongoDB –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ: {e}")
        return []
    finally:
        mongo_client.close()

def compare_logistics_performance():
    """–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã"""
    
    print("üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º")
    print("=" * 60)
    
    # –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
    print("\nüîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ô:")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º MongoDB
    print("\nüìä –ü—Ä–æ–≤–µ—Ä–∫–∞ MongoDB...")
    mongo_ok = check_mongo_connection()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º PostgreSQL
    print("\nüìä –ü—Ä–æ–≤–µ—Ä–∫–∞ PostgreSQL...")
    postgres_ok = False
    try:
        conn_params = {
            "dbname": "studpg",
            "user": "postgres",
            "password": "changeme", 
            "host": "postgresql",  # –û—Å—Ç–∞–≤–ª–µ–Ω–æ –∫–∞–∫ postgresql
            "port": "5432"
        }
        conn = psycopg2.connect(**conn_params)
        with conn.cursor() as cur:
            cur.execute("SELECT COUNT(*) FROM shipments")
            count = cur.fetchone()[0]
            print(f"‚úÖ PostgreSQL –ø–æ–¥–∫–ª—é—á–µ–Ω, –∑–∞–ø–∏—Å–µ–π –≤ shipments: {count}")
        conn.close()
        postgres_ok = True
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ PostgreSQL: {e}")
    
    if not mongo_ok or not postgres_ok:
        print(f"\n‚ùå –ù–µ –≤—Å–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω—ã:")
        print(f"   - PostgreSQL: {'‚úÖ' if postgres_ok else '‚ùå'}")
        print(f"   - MongoDB: {'‚úÖ' if mongo_ok else '‚ùå'}")
        print("üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:")
        print("   - –ó–∞–ø—É—â–µ–Ω—ã –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: docker ps")
        print("   - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ –∫–æ–¥–µ")
        response = input("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ? (y/n): ")
        if response.lower() != 'y':
            return
    
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
    test_scenarios = [
        ("–°—Ç–∞—Ç—É—Å '–í –ø—É—Ç–∏'", "–í –ø—É—Ç–∏"),
        ("–°—Ç–∞—Ç—É—Å '–î–æ—Å—Ç–∞–≤–ª–µ–Ω'", "–î–æ—Å—Ç–∞–≤–ª–µ–Ω"), 
        ("–¢—è–∂–µ–ª—ã–µ –≥—Ä—É–∑—ã (300–∫–≥+)", 300)
    ]
    
    postgres_times = []
    mongodb_times = []
    
    print(f"\n‚ö° –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò")
    
    for scenario_name, param in test_scenarios:
        print(f"\nüß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {scenario_name}")
        
        # PostgreSQL
        if "–°—Ç–∞—Ç—É—Å" in scenario_name:
            _, pg_time = measure_time(get_postgres_shipments_by_status, param)
        else:
            _, pg_time = measure_time(get_postgres_heavy_shipments, param)
        postgres_times.append(pg_time)
        print(f"  PostgreSQL: {pg_time:.4f} —Å–µ–∫")
        
        # MongoDB
        if "–°—Ç–∞—Ç—É—Å" in scenario_name:
            _, mongo_time = measure_time(get_mongodb_shipments_by_status, param)
        else:
            _, mongo_time = measure_time(get_mongodb_heavy_shipments, param)
        mongodb_times.append(mongo_time)
        print(f"  MongoDB: {mongo_time:.4f} —Å–µ–∫")
        
        # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
        if pg_time > 0 and mongo_time > 0:
            if pg_time < mongo_time:
                faster = "PostgreSQL"
                speedup = mongo_time / pg_time
            else:
                faster = "MongoDB" 
                speedup = pg_time / mongo_time
            
            print(f"  üèÜ –ë—ã—Å—Ç—Ä–µ–µ: {faster} (–≤ {speedup:.2f} —Ä–∞–∑)")
        else:
            print(f"  ‚ö†Ô∏è –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å")
    
    # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
    valid_pairs = [(pg, mongo) for pg, mongo in zip(postgres_times, mongodb_times) if pg > 0 and mongo > 0]
    
    if len(valid_pairs) >= 2:  # –ù—É–∂–Ω–æ —Ö–æ—Ç—è –±—ã 2 —Ç–æ—á–∫–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        valid_pg_times = [pg for pg, mongo in valid_pairs]
        valid_mongo_times = [mongo for pg, mongo in valid_pairs]
        valid_scenarios = [test_scenarios[i] for i, (pg, mongo) in enumerate(zip(postgres_times, mongodb_times)) if pg > 0 and mongo > 0]
        
        plt.style.use('seaborn-v0_8')
        sns.set_palette("husl")
        
        plt.figure(figsize=(12, 8))
        
        # –ì—Ä–∞—Ñ–∏–∫ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        x_pos = np.arange(len(valid_scenarios))
        
        plt.subplot(1, 2, 1)
        plt.plot(x_pos, valid_pg_times, 'o-', label='PostgreSQL', linewidth=2, markersize=8)
        plt.plot(x_pos, valid_mongo_times, 's-', label='MongoDB', linewidth=2, markersize=8)
        plt.xlabel('–°—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—Ä–æ—Å–∞')
        plt.ylabel('–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã)')
        plt.title('–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤')
        plt.xticks(x_pos, [name for name, _ in valid_scenarios], rotation=45, ha='right')
        plt.legend()
        plt.grid(True, alpha=0.3)
        
        # –ì—Ä–∞—Ñ–∏–∫ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        plt.subplot(1, 2, 2)
        speedup_ratio = [mongo_time / pg_time for pg_time, mongo_time in valid_pairs]
        colors = ['green' if x > 1 else 'red' for x in speedup_ratio]
        
        bars = plt.bar(x_pos, speedup_ratio, color=colors, alpha=0.7)
        plt.xlabel('–°—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—Ä–æ—Å–∞')
        plt.ylabel('–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (MongoDB/PostgreSQL)')
        plt.title('–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏')
        plt.xticks(x_pos, [name for name, _ in valid_scenarios], rotation=45, ha='right')
        plt.axhline(y=1, color='black', linestyle='--', alpha=0.5)
        plt.grid(True, alpha=0.3)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Å—Ç–æ–ª–±—Ü—ã
        for bar, ratio in zip(bars, speedup_ratio):
            plt.text(bar.get_x() + bar.get_width()/2., bar.get_height() + 0.05,
                    f'{ratio:.2f}x', ha='center', va='bottom')
        
        plt.tight_layout()
        plt.savefig('data/05_performance_comparison.png', dpi=300, bbox_inches='tight')
        plt.show()
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        avg_pg_time = np.mean(valid_pg_times)
        avg_mongo_time = np.mean(valid_mongo_times)
        
        print(f"\nüìã –î–ï–¢–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
        print(f"PostgreSQL - –°—Ä–µ–¥–Ω–µ–µ: {avg_pg_time:.4f}—Å")
        print(f"MongoDB - –°—Ä–µ–¥–Ω–µ–µ: {avg_mongo_time:.4f}—Å")
        print(f"–û–±—â–µ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ PostgreSQL: {avg_mongo_time/avg_pg_time:.2f}x")
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        performance_results = {
            'comparison_time': datetime.now().isoformat(),
            'test_scenarios': [
                {'name': name, 'param': param} for name, param in test_scenarios
            ],
            'performance_times': {
                'postgresql': postgres_times,
                'mongodb': mongodb_times
            },
            'statistics': {
                'postgresql_avg': avg_pg_time,
                'mongodb_avg': avg_mongo_time,
                'speedup_ratio': avg_mongo_time / avg_pg_time
            }
        }
        
        with open('data/05_performance_results.json', 'w', encoding='utf-8') as f:
            json.dump(performance_results, f, ensure_ascii=False, indent=2)
        
        print("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ data/05_performance_results.json")
    else:
        print("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤")

if __name__ == "__main__":
    compare_logistics_performance()
