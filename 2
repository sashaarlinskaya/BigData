import psycopg2
from pymongo import MongoClient
import time
import json
from datetime import datetime
import matplotlib.pyplot as plt
import numpy as np
import seaborn as sns

def check_mongo_connection(client):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB"""
    try:
        client.server_info()
        return True
    except Exception as e:
        return False

def get_mongo_client():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB"""
    try:
        mongo_client = MongoClient('mongodb://mongouser:mongopass@localhost:27017/')
        if check_mongo_connection(mongo_client):
            return mongo_client
    except:
        try:
            mongo_client = MongoClient('mongodb://mongouser:mongopass@mongodb:27017/')
            if check_mongo_connection(mongo_client):
                return mongo_client
        except:
            return None
    return None

def measure_time(func, *args, **kwargs):
    """–ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏"""
    start_time = time.time()
    result = func(*args, **kwargs)
    end_time = time.time()
    return result, end_time - start_time

def get_postgres_shipments_by_status(status):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä—É–∑–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É –≤ PostgreSQL"""
    conn_params = {
        "dbname": "studpg",
        "user": "student", 
        "password": "Stud2024!!!",
        "host": "postgresql",
        "port": "5432"
    }
    
    try:
        conn = psycopg2.connect(**conn_params)
        with conn.cursor() as cur:
            cur.execute("""
                SELECT s.tracking_number, s.status, s.weight, s.value,
                       wf.name as from_warehouse, wt.name as to_warehouse,
                       r.name as route_name
                FROM shipments s
                JOIN warehouses wf ON s.warehouse_from_id = wf.id
                JOIN warehouses wt ON s.warehouse_to_id = wt.id
                JOIN routes r ON s.route_id = r.id
                WHERE s.status = %s
                ORDER BY s.shipment_date DESC
                LIMIT 100
            """, (status,))
            return cur.fetchall()
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ PostgreSQL: {e}")
        return []
    finally:
        conn.close()

def get_mongodb_shipments_by_status(status):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä—É–∑–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É –≤ MongoDB"""
    mongo_client = get_mongo_client()
    if not mongo_client:
        return []
    
    try:
        db = mongo_client['studmongo']
        results = db.shipments.find(
            {"status": status},
            {
                "tracking_number": 1,
                "status": 1,
                "weight": 1,
                "value": 1,
                "warehouse_from.name": 1,
                "warehouse_to.name": 1,
                "route.name": 1,
                "shipment_date": 1
            }
        ).sort("shipment_date", -1).limit(100)
        return list(results)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ MongoDB: {e}")
        return []
    finally:
        mongo_client.close()

def get_postgres_heavy_shipments(weight_threshold):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—è–∂–µ–ª—ã—Ö –≥—Ä—É–∑–æ–≤ –≤ PostgreSQL"""
    conn_params = {
        "dbname": "studpg",
        "user": "student", 
        "password": "Stud2024!!!",
        "host": "postgresql",
        "port": "5432"
    }
    
    try:
        conn = psycopg2.connect(**conn_params)
        with conn.cursor() as cur:
            cur.execute("""
                SELECT s.tracking_number, s.weight, s.value, wf.city, wt.city, r.distance
                FROM shipments s
                JOIN warehouses wf ON s.warehouse_from_id = wf.id
                JOIN warehouses wt ON s.warehouse_to_id = wt.id  
                JOIN routes r ON s.route_id = r.id
                WHERE s.weight > %s
                ORDER BY s.weight DESC
                LIMIT 100
            """, (weight_threshold,))
            return cur.fetchall()
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ PostgreSQL: {e}")
        return []
    finally:
        conn.close()

def get_mongodb_heavy_shipments(weight_threshold):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—è–∂–µ–ª—ã—Ö –≥—Ä—É–∑–æ–≤ –≤ MongoDB"""
    mongo_client = get_mongo_client()
    if not mongo_client:
        return []
    
    try:
        db = mongo_client['studmongo']
        results = db.shipments.find(
            {"weight": {"$gt": weight_threshold}},
            {
                "tracking_number": 1,
                "weight": 1,
                "value": 1,
                "warehouse_from.city": 1,
                "warehouse_to.city": 1,
                "route.distance": 1
            }
        ).sort("weight", -1).limit(100)
        return list(results)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ MongoDB: {e}")
        return []
    finally:
        mongo_client.close()

def compare_logistics_performance():
    """–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã"""
    
    print("üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º")
    print("=" * 60)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
    mongo_client = get_mongo_client()
    if not mongo_client:
        print("‚ùå MongoDB –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏")
        print("–ó–∞–ø—É—Å—Ç–∏—Ç–µ MongoDB: docker compose up -d mongodb")
        return
    
    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
    test_scenarios = [
        ("–°—Ç–∞—Ç—É—Å '–í –ø—É—Ç–∏'", "–í –ø—É—Ç–∏"),
        ("–°—Ç–∞—Ç—É—Å '–î–æ—Å—Ç–∞–≤–ª–µ–Ω'", "–î–æ—Å—Ç–∞–≤–ª–µ–Ω"), 
        ("–¢—è–∂–µ–ª—ã–µ –≥—Ä—É–∑—ã (500–∫–≥+)", 500),
        ("–¢—è–∂–µ–ª—ã–µ –≥—Ä—É–∑—ã (300–∫–≥+)", 300),
        ("–¢—è–∂–µ–ª—ã–µ –≥—Ä—É–∑—ã (700–∫–≥+)", 700)
    ]
    
    postgres_times = []
    mongodb_times = []
    
    for scenario_name, param in test_scenarios:
        print(f"\nüß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {scenario_name}")
        
        # PostgreSQL
        if "–°—Ç–∞—Ç—É—Å" in scenario_name:
            _, pg_time = measure_time(get_postgres_shipments_by_status, param)
        else:
            _, pg_time = measure_time(get_postgres_heavy_shipments, param)
        postgres_times.append(pg_time)
        print(f"  PostgreSQL: {pg_time:.4f} —Å–µ–∫")
        
        # MongoDB
        if "–°—Ç–∞—Ç—É—Å" in scenario_name:
            _, mongo_time = measure_time(get_mongodb_shipments_by_status, param)
        else:
            _, mongo_time = measure_time(get_mongodb_heavy_shipments, param)
        mongodb_times.append(mongo_time)
        print(f"  MongoDB: {mongo_time:.4f} —Å–µ–∫")
        
        # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
        if pg_time < mongo_time:
            faster = "PostgreSQL"
            speedup = mongo_time / pg_time
        else:
            faster = "MongoDB" 
            speedup = pg_time / mongo_time
        
        print(f"  üèÜ –ë—ã—Å—Ç—Ä–µ–µ: {faster} (–≤ {speedup:.2f} —Ä–∞–∑)")
    
    # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    plt.style.use('seaborn-v0_8')
    sns.set_palette("husl")
    
    plt.figure(figsize=(15, 10))
    
    # –ì—Ä–∞—Ñ–∏–∫ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    plt.subplot(2, 2, 1)
    scenario_names = [name for name, _ in test_scenarios]
    x_pos = np.arange(len(scenario_names))
    
    plt.plot(x_pos, postgres_times, 'o-', label='PostgreSQL', linewidth=2, markersize=8)
    plt.plot(x_pos, mongodb_times, 's-', label='MongoDB', linewidth=2, markersize=8)
    plt.xlabel('–°—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—Ä–æ—Å–∞')
    plt.ylabel('–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã)')
    plt.title('–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤')
    plt.xticks(x_pos, scenario_names, rotation=45, ha='right')
    plt.legend()
    plt.grid(True, alpha=0.3)
    plt.tight_layout()
    
    # –ì—Ä–∞—Ñ–∏–∫ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    plt.subplot(2, 2, 2)
    speedup_ratio = [mongo_time / pg_time for pg_time, mongo_time in zip(postgres_times, mongodb_times)]
    colors = ['green' if x > 1 else 'red' for x in speedup_ratio]
    
    bars = plt.bar(x_pos, speedup_ratio, color=colors, alpha=0.7)
    plt.xlabel('–°—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—Ä–æ—Å–∞')
    plt.ylabel('–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (MongoDB/PostgreSQL)')
    plt.title('–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏')
    plt.xticks(x_pos, scenario_names, rotation=45, ha='right')
    plt.axhline(y=1, color='black', linestyle='--', alpha=0.5)
    plt.grid(True, alpha=0.3)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Å—Ç–æ–ª–±—Ü—ã
    for bar, ratio in zip(bars, speedup_ratio):
        plt.text(bar.get_x() + bar.get_width()/2., bar.get_height() + 0.05,
                f'{ratio:.2f}x', ha='center', va='bottom')
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    plt.subplot(2, 2, 3)
    avg_pg_time = np.mean(postgres_times)
    avg_mongo_time = np.mean(mongodb_times)
    std_pg_time = np.std(postgres_times)
    std_mongo_time = np.std(mongodb_times)
    
    databases = ['PostgreSQL', 'MongoDB']
    avg_times = [avg_pg_time, avg_mongo_time]
    std_times = [std_pg_time, std_mongo_time]
    
    bars = plt.bar(databases, avg_times, yerr=std_times, capsize=5, 
                   color=['blue', 'orange'], alpha=0.7)
    plt.ylabel('–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã)')
    plt.title('–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å')
    plt.grid(True, alpha=0.3)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Å—Ç–æ–ª–±—Ü—ã
    for bar, avg, std in zip(bars, avg_times, std_times):
        plt.text(bar.get_x() + bar.get_width()/2., bar.get_height() + 0.01,
                f'{avg:.4f}¬±{std:.4f}', ha='center', va='bottom', fontsize=9)
    
    # –í—ã–≤–æ–¥—ã
    plt.subplot(2, 2, 4)
    plt.axis('off')
    
    faster_count = sum(1 for pg, mongo in zip(postgres_times, mongodb_times) if pg < mongo)
    mongo_faster_count = len(postgres_times) - faster_count
    
    conclusion_text = f"""
üìà –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –õ–û–ì–ò–°–¢–ò–ß–ï–°–ö–û–ô –°–ò–°–¢–ï–ú–´:

üèÜ –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
‚Ä¢ PostgreSQL: {avg_pg_time:.4f} ¬± {std_pg_time:.4f} —Å–µ–∫
‚Ä¢ MongoDB: {avg_mongo_time:.4f} ¬± {std_mongo_time:.4f} —Å–µ–∫

‚ö° –û–±—â–µ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ:
‚Ä¢ PostgreSQL –±—ã—Å—Ç—Ä–µ–µ –≤ {avg_mongo_time/avg_pg_time:.2f} —Ä–∞–∑
‚Ä¢ PostgreSQL –≤—ã–∏–≥—Ä–∞–ª –≤ {faster_count} –∏–∑ {len(test_scenarios)} —Ç–µ—Å—Ç–æ–≤
‚Ä¢ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: {'PostgreSQL' if std_pg_time < std_mongo_time else 'MongoDB'}

üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏–∫–∏:
‚Ä¢ –î–ª—è JOIN-–∑–∞–ø—Ä–æ—Å–æ–≤: PostgreSQL
‚Ä¢ –î–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: MongoDB  
‚Ä¢ –î–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: PostgreSQL
‚Ä¢ –î–ª—è –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –¥–æ—Å—Ç—É–ø–∞
"""
    plt.text(0.1, 0.5, conclusion_text, fontsize=10, verticalalignment='center',
             bbox=dict(boxstyle="round,pad=0.3", facecolor="lightblue", alpha=0.8))
    
    plt.tight_layout()
    plt.savefig('data/05_performance_comparison.png', dpi=300, bbox_inches='tight')
    plt.show()
    
    # –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    print(f"\nüìã –î–ï–¢–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
    print(f"PostgreSQL - –°—Ä–µ–¥–Ω–µ–µ: {avg_pg_time:.4f}—Å, –°—Ç–¥. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: {std_pg_time:.4f}—Å")
    print(f"MongoDB - –°—Ä–µ–¥–Ω–µ–µ: {avg_mongo_time:.4f}—Å, –°—Ç–¥. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: {std_mongo_time:.4f}—Å")
    print(f"–û–±—â–µ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ PostgreSQL: {avg_mongo_time/avg_pg_time:.2f}x")
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    performance_results = {
        'comparison_time': datetime.now().isoformat(),
        'test_scenarios': [
            {'name': name, 'param': param} for name, param in test_scenarios
        ],
        'performance_times': {
            'postgresql': postgres_times,
            'mongodb': mongodb_times
        },
        'statistics': {
            'postgresql_avg': avg_pg_time,
            'postgresql_std': std_pg_time,
            'mongodb_avg': avg_mongo_time,
            'mongodb_std': std_mongo_time,
            'postgresql_wins': faster_count,
            'mongodb_wins': mongo_faster_count
        }
    }
    
    with open('data/05_performance_results.json', 'w', encoding='utf-8') as f:
        json.dump(performance_results, f, ensure_ascii=False, indent=2)
    
    print("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ data/05_performance_results.json")

if __name__ == "__main__":
    compare_logistics_performance()
