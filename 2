import psycopg2
from pymongo import MongoClient
import time
import json
from datetime import datetime

def check_mongo_connection(client):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB"""
    try:
        client.server_info()
        return True
    except Exception as e:
        return False

def get_mongo_client():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏"""
    mongo_client = None
    
    try:
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º localhost
        mongo_client = MongoClient('mongodb://mongouser:mongopass@localhost:27017/')
        if check_mongo_connection(mongo_client):
            print("  ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB —á–µ—Ä–µ–∑ localhost")
            return mongo_client
        else:
            raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ localhost")
    except:
        try:
            # –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ docker —Å–µ—Ä–≤–∏—Å
            mongo_client = MongoClient('mongodb://mongouser:mongopass@mongodb:27017/')
            if check_mongo_connection(mongo_client):
                print("  ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB —á–µ—Ä–µ–∑ docker —Å–µ—Ä–≤–∏—Å")
                return mongo_client
            else:
                raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ docker —Å–µ—Ä–≤–∏—Å")
        except:
            print("  ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MongoDB")
            return None

def measure_postgres_performance():
    """–ò–∑–º–µ—Ä–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ PostgreSQL"""
    
    conn_params = {
        "dbname": "studpg",
        "user": "student", 
        "password": "Stud2024!!!",
        "host": "postgresql",
        "port": "5432"
    }
    
    results = {}
    
    try:
        conn = psycopg2.connect(**conn_params)
        
        # –ó–∞–ø—Ä–æ—Å 1: –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –ø–æ —Å—Ç–∞—Ç—É—Å—É
        print("  üìä PostgreSQL: –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫...")
        start_time = time.time()
        with conn.cursor() as cur:
            cur.execute("SELECT COUNT(*) FROM shipments WHERE status = '–í –ø—É—Ç–∏'")
            count = cur.fetchone()[0]
        query1_time = time.time() - start_time
        
        # –ó–∞–ø—Ä–æ—Å 2: –ü–æ–∏—Å–∫ —Å JOIN
        print("  üìä PostgreSQL: –ü–æ–∏—Å–∫ —Å JOIN...")
        start_time = time.time()
        with conn.cursor() as cur:
            cur.execute("""
                SELECT s.tracking_number, wf.city, wt.city, r.distance
                FROM shipments s
                JOIN warehouses wf ON s.warehouse_from_id = wf.id
                JOIN warehouses wt ON s.warehouse_to_id = wt.id  
                JOIN routes r ON s.route_id = r.id
                WHERE s.weight > 500
                LIMIT 1000
            """)
            results_data = cur.fetchall()
        query2_time = time.time() - start_time
        
        # –ó–∞–ø—Ä–æ—Å 3: –ê–≥—Ä–µ–≥–∞—Ü–∏—è
        print("  üìä PostgreSQL: –ê–≥—Ä–µ–≥–∞—Ü–∏—è...")
        start_time = time.time()
        with conn.cursor() as cur:
            cur.execute("""
                SELECT status, COUNT(*), AVG(weight), AVG(value)
                FROM shipments 
                GROUP BY status
            """)
            agg_results = cur.fetchall()
        query3_time = time.time() - start_time
        
        results = {
            'query1_simple_search': round(query1_time, 4),
            'query2_join_search': round(query2_time, 4),
            'query3_aggregation': round(query3_time, 4),
            'records_found': {
                'in_transit': count,
                'heavy_shipments': len(results_data),
                'status_groups': len(agg_results)
            }
        }
        
        conn.close()
        
    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ PostgreSQL: {e}")
        results = {'error': str(e)}
    
    return results

def measure_mongodb_performance():
    """–ò–∑–º–µ—Ä–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ MongoDB"""
    
    results = {}
    
    mongo_client = get_mongo_client()
    if not mongo_client:
        return {'error': '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MongoDB'}
    
    try:
        db = mongo_client['studmongo']
        
        # –ó–∞–ø—Ä–æ—Å 1: –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –ø–æ —Å—Ç–∞—Ç—É—Å—É
        print("  üìä MongoDB: –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫...")
        start_time = time.time()
        count = db.shipments.count_documents({"status": "–í –ø—É—Ç–∏"})
        query1_time = time.time() - start_time
        
        # –ó–∞–ø—Ä–æ—Å 2: –ü–æ–∏—Å–∫ —Å "JOIN" (–≤–ª–æ–∂–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã)
        print("  üìä MongoDB: –ü–æ–∏—Å–∫ —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏...")
        start_time = time.time()
        results_data = list(db.shipments.find(
            {"weight": {"$gt": 500}},
            {
                "tracking_number": 1,
                "warehouse_from.city": 1,
                "warehouse_to.city": 1, 
                "route.distance": 1
            }
        ).limit(1000))
        query2_time = time.time() - start_time
        
        # –ó–∞–ø—Ä–æ—Å 3: –ê–≥—Ä–µ–≥–∞—Ü–∏—è
        print("  üìä MongoDB: –ê–≥—Ä–µ–≥–∞—Ü–∏—è...")
        start_time = time.time()
        pipeline = [
            {"$group": {
                "_id": "$status",
                "count": {"$sum": 1},
                "avg_weight": {"$avg": "$weight"},
                "avg_value": {"$avg": "$value"}
            }}
        ]
        agg_results = list(db.shipments.aggregate(pipeline))
        query3_time = time.time() - start_time
        
        results = {
            'query1_simple_search': round(query1_time, 4),
            'query2_nested_search': round(query2_time, 4),
            'query3_aggregation': round(query3_time, 4),
            'records_found': {
                'in_transit': count,
                'heavy_shipments': len(results_data),
                'status_groups': len(agg_results)
            }
        }
        
        mongo_client.close()
        
    except Exception as e:
        print(f"  ‚ùå –û—à–∏–±–∫–∞ MongoDB: {e}")
        results = {'error': str(e)}
    
    return results

def compare_performance():
    """–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ PostgreSQL –∏ MongoDB"""
    
    print("‚ö° –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò")
    print("=" * 50)
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞–∑–º–µ—Ä–∞—Ö
    try:
        with open('data/02_postgres_metadata.json', 'r') as f:
            pg_meta = json.load(f)
    except:
        pg_meta = {'database_size': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
    
    try:
        with open('data/03_mongodb_metadata.json', 'r') as f:
            mongo_meta = json.load(f)
    except:
        mongo_meta = {'collections': {'shipments': {'size_mb': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}}}
    
    # –ò–∑–º–µ—Ä–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    print("\nüìä PostgreSQL - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤...")
    pg_results = measure_postgres_performance()
    
    print("\nüìä MongoDB - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤...")
    mongo_results = measure_mongodb_performance()
    
    # –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    comparison = {
        'comparison_time': datetime.now().isoformat(),
        'storage_comparison': {
            'postgresql_size': pg_meta.get('database_size', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'),
            'mongodb_size': f"{mongo_meta.get('collections', {}).get('shipments', {}).get('size_mb', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')} MB"
        },
        'performance_results': {
            'postgresql': pg_results,
            'mongodb': mongo_results
        },
        'analysis': {}
    }
    
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    if 'error' not in pg_results and 'error' not in mongo_results:
        query_mapping = {
            'query1_simple_search': 'query1_simple_search',
            'query2_join_search': 'query2_nested_search', 
            'query3_aggregation': 'query3_aggregation'
        }
        
        for pg_query, mongo_query in query_mapping.items():
            pg_time = pg_results.get(pg_query)
            mongo_time = mongo_results.get(mongo_query)
            
            if pg_time and mongo_time:
                faster = 'PostgreSQL' if pg_time < mongo_time else 'MongoDB'
                speedup = max(pg_time, mongo_time) / min(pg_time, mongo_time)
                
                comparison['analysis'][pg_query] = {
                    'postgresql_time': pg_time,
                    'mongodb_time': mongo_time,
                    'faster': faster,
                    'speedup_ratio': round(speedup, 2)
                }
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    with open('data/04_performance_comparison.json', 'w', encoding='utf-8') as f:
        json.dump(comparison, f, ensure_ascii=False, indent=2)
    
    # –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    print("\nüìà –†–ï–ó–£–õ–¨–¢–ê–¢–´ –°–†–ê–í–ù–ï–ù–ò–Ø:")
    print(f"üíæ –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:")
    print(f"   - PostgreSQL: {comparison['storage_comparison']['postgresql_size']}")
    print(f"   - MongoDB: {comparison['storage_comparison']['mongodb_size']}")
    
    if 'analysis' in comparison:
        print("\n‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:")
        for query, stats in comparison['analysis'].items():
            query_name = {
                'query1_simple_search': '–ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫',
                'query2_join_search': '–°–ª–æ–∂–Ω—ã–π –ø–æ–∏—Å–∫', 
                'query3_aggregation': '–ê–≥—Ä–µ–≥–∞—Ü–∏—è'
            }.get(query, query)
            
            print(f"   {query_name}:")
            print(f"     - PostgreSQL: {stats['postgresql_time']}—Å")
            print(f"     - MongoDB: {stats['mongodb_time']}—Å")
            print(f"     - –ë—ã—Å—Ç—Ä–µ–µ: {stats['faster']} (–≤ {stats['speedup_ratio']} —Ä–∞–∑)")
    
    print("\n‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ data/04_performance_comparison.json")
    
    return comparison

if __name__ == "__main__":
    compare_performance()
