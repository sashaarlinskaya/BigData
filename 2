import matplotlib.pyplot as plt
import json

def create_storage_comparison_chart():
    """–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∑–∞–Ω–∏–º–∞–µ–º–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞"""
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞–∑–º–µ—Ä–∞—Ö
    try:
        with open('data/02_postgres_metadata.json', 'r') as f:
            pg_meta = json.load(f)
        
        with open('data/03_mongodb_metadata.json', 'r') as f:
            mongo_meta = json.load(f)
        
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞–∑–º–µ—Ä–∞—Ö
        pg_size_str = pg_meta.get('database_size', '0 MB')
        mongo_size_str = f"{mongo_meta['collections']['shipments']['size_mb']} MB"
        
        # –ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–æ–≤ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç "XX MB")
        pg_size_mb = float(pg_size_str.split()[0])
        mongo_size_mb = float(mongo_size_str.split()[0])
        
        # –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        databases = ['PostgreSQL', 'MongoDB']
        sizes_mb = [pg_size_mb, mongo_size_mb]
        colors = ['#3366cc', '#dc3912']
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
        plt.figure(figsize=(10, 6))
        
        # –°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
        bars = plt.bar(databases, sizes_mb, color=colors, alpha=0.8, width=0.6)
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ —Å—Ç–æ–ª–±—Ü—ã
        for bar, size in zip(bars, sizes_mb):
            plt.text(bar.get_x() + bar.get_width()/2, bar.get_height() + 0.1,
                    f'{size} MB', ha='center', va='bottom', fontsize=12, fontweight='bold')
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        plt.title('–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–Ω–∏–º–∞–µ–º–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö', fontsize=14, fontweight='bold', pad=20)
        plt.ylabel('–†–∞–∑–º–µ—Ä (MB)', fontsize=12)
        plt.grid(axis='y', alpha=0.3)
        plt.ylim(0, max(sizes_mb) * 1.2)
        
        # –†–∞—Å—á–µ—Ç —Ä–∞–∑–Ω–∏—Ü—ã
        difference = pg_size_mb - mongo_size_mb
        difference_percent = (difference / mongo_size_mb) * 100
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Å —Ä–∞–∑–Ω–∏—Ü–µ–π
        if difference > 0:
            plt.annotate(f'PostgreSQL –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–∞ {difference:.1f} MB ({difference_percent:.1f}%) –±–æ–ª—å—à–µ',
                        xy=(0.5, 0.95), xycoords='axes fraction',
                        ha='center', fontsize=11, style='italic',
                        bbox=dict(boxstyle="round,pad=0.3", facecolor="lightyellow", alpha=0.7))
        else:
            plt.annotate(f'MongoDB –∑–∞–Ω–∏–º–∞–µ—Ç –Ω–∞ {abs(difference):.1f} MB ({abs(difference_percent):.1f}%) –±–æ–ª—å—à–µ',
                        xy=(0.5, 0.95), xycoords='axes fraction',
                        ha='center', fontsize=11, style='italic',
                        bbox=dict(boxstyle="round,pad=0.3", facecolor="lightyellow", alpha=0.7))
        
        plt.tight_layout()
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
        plt.savefig('data/storage_comparison.png', dpi=300, bbox_inches='tight')
        plt.show()
        
        # –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Å–æ–ª—å
        print("üìä –°–†–ê–í–ù–ï–ù–ò–ï –ó–ê–ù–ò–ú–ê–ï–ú–û–ì–û –ü–†–û–°–¢–†–ê–ù–°–¢–í–ê")
        print("=" * 50)
        print(f"üóÑÔ∏è PostgreSQL: {pg_size_mb} MB")
        print(f"üçÉ MongoDB: {mongo_size_mb} MB")
        print(f"üìà –†–∞–∑–Ω–∏—Ü–∞: {abs(difference):.1f} MB ({abs(difference_percent):.1f}%)")
        
        if difference > 0:
            print("‚úÖ MongoDB —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ")
        else:
            print("‚úÖ PostgreSQL —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ")
            
        print(f"\nüíæ –ì—Ä–∞—Ñ–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫: data/storage_comparison.png")
        
        return {
            'postgresql_size_mb': pg_size_mb,
            'mongodb_size_mb': mongo_size_mb,
            'difference_mb': abs(difference),
            'difference_percent': abs(difference_percent)
        }
        
    except FileNotFoundError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω: {e}")
        return None
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞: {e}")
        return None

if __name__ == "__main__":
    create_storage_comparison_chart()
