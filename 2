import psycopg2
import json
import pandas as pd
from datetime import datetime

def setup_postgres_database():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö"""
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    conn_params = {
        "dbname": "studpg",
        "user": "student", 
        "password": "Stud2024!!!",
        "host": "postgresql",
        "port": "5432"
    }
    
    try:
        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
        conn = psycopg2.connect(**conn_params)
        print("‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL")
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        with open('data/01_generated_data.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
        with conn.cursor() as cur:
            # –£–¥–∞–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü
            cur.execute("DROP TABLE IF EXISTS shipments CASCADE")
            cur.execute("DROP TABLE IF EXISTS routes CASCADE") 
            cur.execute("DROP TABLE IF EXISTS warehouses CASCADE")
            
            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å–∫–ª–∞–¥–æ–≤
            cur.execute("""
                CREATE TABLE warehouses (
                    id INTEGER PRIMARY KEY,
                    name VARCHAR(100),
                    city VARCHAR(50),
                    type VARCHAR(50),
                    capacity INTEGER,
                    employees INTEGER,
                    latitude DECIMAL(10,6),
                    longitude DECIMAL(10,6)
                )
            """)
            
            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤
            cur.execute("""
                CREATE TABLE routes (
                    id INTEGER PRIMARY KEY,
                    name VARCHAR(100),
                    start_city VARCHAR(50),
                    end_city VARCHAR(50),
                    distance INTEGER,
                    duration_hours INTEGER,
                    transport_type VARCHAR(50),
                    status VARCHAR(50),
                    cost_per_km DECIMAL(10,2)
                )
            """)
            
            # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≥—Ä—É–∑–æ–≤
            cur.execute("""
                CREATE TABLE shipments (
                    id INTEGER PRIMARY KEY,
                    tracking_number VARCHAR(20) UNIQUE,
                    warehouse_from_id INTEGER REFERENCES warehouses(id),
                    warehouse_to_id INTEGER REFERENCES warehouses(id),
                    route_id INTEGER REFERENCES routes(id),
                    weight DECIMAL(10,2),
                    volume DECIMAL(10,2),
                    value DECIMAL(10,2),
                    shipment_date TIMESTAMP,
                    delivery_date TIMESTAMP,
                    status VARCHAR(50),
                    type VARCHAR(50),
                    priority VARCHAR(20)
                )
            """)
            
            print("‚úÖ –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã")
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        print("üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL...")
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–ª–∞–¥–æ–≤
        with conn.cursor() as cur:
            for warehouse in data['warehouses']:
                cur.execute("""
                    INSERT INTO warehouses VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
                """, (warehouse['id'], warehouse['name'], warehouse['city'], 
                      warehouse['type'], warehouse['capacity'], warehouse['employees'],
                      warehouse['latitude'], warehouse['longitude']))
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤
        with conn.cursor() as cur:
            for route in data['routes']:
                cur.execute("""
                    INSERT INTO routes VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
                """, (route['id'], route['name'], route['start_city'], route['end_city'],
                      route['distance'], route['duration_hours'], route['transport_type'],
                      route['status'], route['cost_per_km']))
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–∑–æ–≤
        with conn.cursor() as cur:
            for shipment in data['shipments']:
                cur.execute("""
                    INSERT INTO shipments VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                """, (shipment['id'], shipment['tracking_number'], shipment['warehouse_from_id'],
                      shipment['warehouse_to_id'], shipment['route_id'], shipment['weight'],
                      shipment['volume'], shipment['value'], shipment['shipment_date'],
                      shipment['delivery_date'], shipment['status'], shipment['type'],
                      shipment['priority']))
        
        conn.commit()
        print("‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ PostgreSQL")
        
        # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        with conn.cursor() as cur:
            cur.execute("SELECT pg_size_pretty(pg_database_size('studpg'))")
            db_size = cur.fetchone()[0]
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        postgres_metadata = {
            'setup_time': datetime.now().isoformat(),
            'tables_created': ['warehouses', 'routes', 'shipments'],
            'records_loaded': {
                'warehouses': len(data['warehouses']),
                'routes': len(data['routes']), 
                'shipments': len(data['shipments'])
            },
            'database_size': db_size,
            'indexes_created': [
                'PRIMARY KEY –Ω–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö',
                'UNIQUE –Ω–∞ tracking_number'
            ]
        }
        
        with open('data/02_postgres_metadata.json', 'w', encoding='utf-8') as f:
            json.dump(postgres_metadata, f, ensure_ascii=False, indent=2)
        
        print(f"üíæ –†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {db_size}")
        print("‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ data/02_postgres_metadata.json")
        
        conn.close()
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return None

if __name__ == "__main__":
    setup_postgres_database()
