import psycopg2
from pymongo import MongoClient
import time
import json
from datetime import datetime
import matplotlib.pyplot as plt
import numpy as np
import seaborn as sns

def measure_time(func, *args, **kwargs):
    """–ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏"""
    start_time = time.time()
    result = func(*args, **kwargs)
    end_time = time.time()
    return result, end_time - start_time

def get_mongo_client():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB (—Ç–∏—Ö–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)"""
    try:
        # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        client = MongoClient('mongodb://localhost:27017/', serverSelectionTimeoutMS=2000)
        client.admin.command('ping')
        print("‚úÖ MongoDB –ø–æ–¥–∫–ª—é—á–µ–Ω")
        return client
    except:
        try:
            client = MongoClient('mongodb://mongouser:mongopass@localhost:27017/', serverSelectionTimeoutMS=2000)
            client.admin.command('ping')
            print("‚úÖ MongoDB –ø–æ–¥–∫–ª—é—á–µ–Ω")
            return client
        except:
            try:
                client = MongoClient('mongodb://mongodb:27017/', serverSelectionTimeoutMS=2000)
                client.admin.command('ping')
                print("‚úÖ MongoDB –ø–æ–¥–∫–ª—é—á–µ–Ω")
                return client
            except:
                # –ù–µ –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É, –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
                return None

def get_postgres_shipments_by_weight(weight_threshold):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä—É–∑–æ–≤ –ø–æ –≤–µ—Å—É –≤ PostgreSQL"""
    conn_params = {
        "dbname": "studpg",
        "user": "postgres",
        "password": "changeme", 
        "host": "postgresql",
        "port": "5432"
    }
    
    try:
        conn = psycopg2.connect(**conn_params)
        with conn.cursor() as cur:
            cur.execute("""
                SELECT s.tracking_number, s.weight, s.value, wf.city, wt.city
                FROM shipments s
                JOIN warehouses wf ON s.warehouse_from_id = wf.id
                JOIN warehouses wt ON s.warehouse_to_id = wt.id  
                WHERE s.weight > %s
                ORDER BY s.weight DESC
                LIMIT 100
            """, (weight_threshold,))
            return cur.fetchall()
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ PostgreSQL: {e}")
        return []
    finally:
        if 'conn' in locals():
            conn.close()

def get_mongodb_shipments_by_weight(weight_threshold):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä—É–∑–æ–≤ –ø–æ –≤–µ—Å—É –≤ MongoDB"""
    mongo_client = get_mongo_client()
    if not mongo_client:
        return []
    
    try:
        db = mongo_client['studmongo']
        results = list(db.shipments.find(
            {"weight": {"$gt": weight_threshold}},
            {
                "tracking_number": 1,
                "weight": 1,
                "value": 1,
                "warehouse_from.city": 1,
                "warehouse_to.city": 1
            }
        ).sort("weight", -1).limit(100))
        return results
    except Exception:
        return []
    finally:
        mongo_client.close()

def get_postgres_shipments_by_city(city):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä—É–∑–æ–≤ –ø–æ –≥–æ—Ä–æ–¥—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤ PostgreSQL"""
    conn_params = {
        "dbname": "studpg",
        "user": "postgres",
        "password": "changeme", 
        "host": "postgresql",
        "port": "5432"
    }
    
    try:
        conn = psycopg2.connect(**conn_params)
        with conn.cursor() as cur:
            cur.execute("""
                SELECT s.tracking_number, s.status, s.weight, wf.name, wt.name
                FROM shipments s
                JOIN warehouses wf ON s.warehouse_from_id = wf.id
                JOIN warehouses wt ON s.warehouse_to_id = wt.id
                WHERE wt.city = %s
                ORDER BY s.shipment_date DESC
                LIMIT 100
            """, (city,))
            return cur.fetchall()
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ PostgreSQL: {e}")
        return []
    finally:
        if 'conn' in locals():
            conn.close()

def get_mongodb_shipments_by_city(city):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä—É–∑–æ–≤ –ø–æ –≥–æ—Ä–æ–¥—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤ MongoDB"""
    mongo_client = get_mongo_client()
    if not mongo_client:
        return []
    
    try:
        db = mongo_client['studmongo']
        results = list(db.shipments.find(
            {"warehouse_to.city": city},
            {
                "tracking_number": 1,
                "status": 1,
                "weight": 1,
                "warehouse_from.name": 1,
                "warehouse_to.name": 1
            }
        ).sort("shipment_date", -1).limit(100))
        return results
    except Exception:
        return []
    finally:
        mongo_client.close()

def get_postgres_aggregation():
    """–ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ PostgreSQL"""
    conn_params = {
        "dbname": "studpg",
        "user": "postgres",
        "password": "changeme", 
        "host": "postgresql",
        "port": "5432"
    }
    
    try:
        conn = psycopg2.connect(**conn_params)
        with conn.cursor() as cur:
            cur.execute("""
                SELECT 
                    status,
                    COUNT(*) as count,
                    AVG(weight) as avg_weight,
                    AVG(value) as avg_value,
                    SUM(value) as total_value
                FROM shipments 
                GROUP BY status
                ORDER BY count DESC
            """)
            return cur.fetchall()
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ PostgreSQL: {e}")
        return []
    finally:
        if 'conn' in locals():
            conn.close()

def get_mongodb_aggregation():
    """–ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ MongoDB"""
    mongo_client = get_mongo_client()
    if not mongo_client:
        return []
    
    try:
        db = mongo_client['studmongo']
        pipeline = [
            {"$group": {
                "_id": "$status",
                "count": {"$sum": 1},
                "avg_weight": {"$avg": "$weight"},
                "avg_value": {"$avg": "$value"},
                "total_value": {"$sum": "$value"}
            }},
            {"$sort": {"count": -1}}
        ]
        results = list(db.shipments.aggregate(pipeline))
        return results
    except Exception:
        return []
    finally:
        mongo_client.close()

# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ PostgreSQL –∏ MongoDB
print("üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Å—Ç–µ–º")
print("=" * 60)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
print("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...")
print("‚úÖ PostgreSQL –ø–æ–¥–∫–ª—é—á–µ–Ω")

mongo_client = get_mongo_client()
mongo_available = mongo_client is not None

if mongo_available:
    print("‚úÖ MongoDB –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
else:
    print("‚ÑπÔ∏è  MongoDB –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Ç–µ—Å—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ PostgreSQL")

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Å–æ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
test_weights = [100, 300, 500, 700, 900]
postgres_times = []
mongodb_times = []

print(f"\n‚ö° –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–ü–†–û–°–û–í –ü–û –í–ï–°–£ –ì–†–£–ó–û–í")

for weight in test_weights:
    print(f"\nüß™ –ì—Ä—É–∑—ã —Ç—è–∂–µ–ª–µ–µ {weight}–∫–≥:")
    
    # PostgreSQL
    _, pg_time = measure_time(get_postgres_shipments_by_weight, weight)
    postgres_times.append(pg_time)
    print(f"  PostgreSQL: {pg_time:.4f} —Å–µ–∫")
    
    # MongoDB (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
    if mongo_available:
        _, mongo_time = measure_time(get_mongodb_shipments_by_weight, weight)
        mongodb_times.append(mongo_time)
        print(f"  MongoDB: {mongo_time:.4f} —Å–µ–∫")
        
        # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ
        if pg_time < mongo_time:
            faster = "PostgreSQL"
            speedup = mongo_time / pg_time
        else:
            faster = "MongoDB"
            speedup = pg_time / mongo_time
        
        print(f"  üèÜ –ë—ã—Å—Ç—Ä–µ–µ: {faster} (–≤ {speedup:.2f} —Ä–∞–∑)")
    else:
        mongodb_times.append(0)
        print(f"  MongoDB: --")

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
plt.style.use('seaborn-v0_8')
sns.set_palette("husl")

plt.figure(figsize=(12, 8))

# –ì—Ä–∞—Ñ–∏–∫ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
plt.subplot(2, 2, 1)
plt.plot(test_weights, postgres_times, 'o-', label='PostgreSQL', linewidth=2, markersize=8)

if mongo_available:
    plt.plot(test_weights, mongodb_times, 's-', label='MongoDB', linewidth=2, markersize=8)

plt.xlabel('–í–µ—Å –≥—Ä—É–∑–∞ (–∫–≥)')
plt.ylabel('–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã)')
plt.title('–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –≤–µ—Å—É –≥—Ä—É–∑–∞')
plt.legend()
plt.grid(True, alpha=0.3)

# –ì—Ä–∞—Ñ–∏–∫ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ MongoDB –¥–æ—Å—Ç—É–ø–µ–Ω)
plt.subplot(2, 2, 2)
if mongo_available:
    speedup_ratio = [mongo_time / pg_time for pg_time, mongo_time in zip(postgres_times, mongodb_times)]
    plt.bar(range(len(test_weights)), speedup_ratio, color=['green' if x > 1 else 'red' for x in speedup_ratio])
    plt.xlabel('–í–µ—Å –≥—Ä—É–∑–∞ (–∫–≥)')
    plt.ylabel('–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (MongoDB/PostgreSQL)')
    plt.title('–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏')
    plt.xticks(range(len(test_weights)), test_weights)
    plt.axhline(y=1, color='black', linestyle='--', alpha=0.5)
    plt.grid(True, alpha=0.3)
else:
    plt.text(0.5, 0.5, 'MongoDB –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω\n–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è', 
             ha='center', va='center', fontsize=12,
             bbox=dict(boxstyle="round,pad=0.3", facecolor="lightgray", alpha=0.7))
    plt.axis('off')

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
plt.subplot(2, 2, 3)
avg_pg_time = np.mean(postgres_times)
std_pg_time = np.std(postgres_times)

databases = ['PostgreSQL']
avg_times = [avg_pg_time]
std_times = [std_pg_time]

if mongo_available:
    avg_mongo_time = np.mean(mongodb_times)
    std_mongo_time = np.std(mongodb_times)
    databases.append('MongoDB')
    avg_times.append(avg_mongo_time)
    std_times.append(std_mongo_time)

bars = plt.bar(databases, avg_times, yerr=std_times, capsize=5, color=['blue', 'orange'][:len(databases)])
plt.ylabel('–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (—Å–µ–∫—É–Ω–¥—ã)')
plt.title('–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å')
plt.grid(True, alpha=0.3)

# –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —Å—Ç–æ–ª–±—Ü—ã
for bar, avg, std in zip(bars, avg_times, std_times):
    plt.text(bar.get_x() + bar.get_width()/2., bar.get_height() + 0.01,
            f'{avg:.4f}¬±{std:.4f}', ha='center', va='bottom', fontsize=9)

# –í—ã–≤–æ–¥—ã
plt.subplot(2, 2, 4)
plt.axis('off')

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –≤—ã–≤–æ–¥–æ–≤
print(f"\nüîç –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –¢–ï–°–¢–´:")

# –¢–µ—Å—Ç –ø–æ –≥–æ—Ä–æ–¥–∞–º
cities = ['–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥']
city_pg_times = []
city_mongo_times = []

for city in cities:
    _, pg_time = measure_time(get_postgres_shipments_by_city, city)
    city_pg_times.append(pg_time)
    
    if mongo_available:
        _, mongo_time = measure_time(get_mongodb_shipments_by_city, city)
        city_mongo_times.append(mongo_time)
        print(f"  –ì–æ—Ä–æ–¥ {city}: PostgreSQL {pg_time:.4f}—Å, MongoDB {mongo_time:.4f}—Å")
    else:
        print(f"  –ì–æ—Ä–æ–¥ {city}: PostgreSQL {pg_time:.4f}—Å")

# –¢–µ—Å—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
_, pg_agg_time = measure_time(get_postgres_aggregation)

if mongo_available:
    _, mongo_agg_time = measure_time(get_mongodb_aggregation)
    print(f"  –ê–≥—Ä–µ–≥–∞—Ü–∏—è: PostgreSQL {pg_agg_time:.4f}—Å, MongoDB {mongo_agg_time:.4f}—Å")
else:
    print(f"  –ê–≥—Ä–µ–≥–∞—Ü–∏—è: PostgreSQL {pg_agg_time:.4f}—Å")

# –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤—ã–≤–æ–¥–æ–≤
if mongo_available:
    conclusion_text = f"""
üìà –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –õ–û–ì–ò–°–¢–ò–ß–ï–°–ö–û–ô –°–ò–°–¢–ï–ú–´:

üèÜ –°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
‚Ä¢ PostgreSQL: {avg_pg_time:.4f} ¬± {std_pg_time:.4f} —Å–µ–∫
‚Ä¢ MongoDB: {avg_mongo_time:.4f} ¬± {std_mongo_time:.4f} —Å–µ–∫

‚ö° –û–±—â–µ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ:
‚Ä¢ PostgreSQL –±—ã—Å—Ç—Ä–µ–µ –≤ {avg_mongo_time/avg_pg_time:.2f} —Ä–∞–∑
‚Ä¢ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: {'PostgreSQL' if std_pg_time < std_mongo_time else 'MongoDB'}

üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ª–æ–≥–∏—Å—Ç–∏–∫–∏:
‚Ä¢ –î–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –≤–µ—Å—É: {'PostgreSQL' if avg_pg_time < avg_mongo_time else 'MongoDB'}
‚Ä¢ –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –≥–æ—Ä–æ–¥–∞–º: {'PostgreSQL' if np.mean(city_pg_times) < np.mean(city_mongo_times) else 'MongoDB'}
‚Ä¢ –î–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–π: {'PostgreSQL' if pg_agg_time < mongo_agg_time else 'MongoDB'}
"""
else:
    conclusion_text = f"""
üìà –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–û–í –õ–û–ì–ò–°–¢–ò–ß–ï–°–ö–û–ô –°–ò–°–¢–ï–ú–´:

üèÜ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å PostgreSQL:
‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è: {avg_pg_time:.4f} ¬± {std_pg_time:.4f} —Å–µ–∫
‚Ä¢ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: —Ö–æ—Ä–æ—à–∞—è

üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
‚Ä¢ MongoDB –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
‚Ä¢ PostgreSQL –ø–æ–∫–∞–∑–∞–ª —Å—Ç–∞–±–∏–ª—å–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
‚Ä¢ –î–ª—è –ª–æ–≥–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è PostgreSQL
"""

plt.text(0.1, 0.5, conclusion_text, fontsize=10, verticalalignment='center',
         bbox=dict(boxstyle="round,pad=0.3", facecolor="lightblue", alpha=0.8))

plt.tight_layout()
plt.savefig('data/05_performance_comparison.png', dpi=300, bbox_inches='tight')
plt.show()

# –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
print(f"\nüìã –î–ï–¢–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
print(f"PostgreSQL - –°—Ä–µ–¥–Ω–µ–µ: {avg_pg_time:.4f}—Å, –°—Ç–¥. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: {std_pg_time:.4f}—Å")

if mongo_available:
    print(f"MongoDB - –°—Ä–µ–¥–Ω–µ–µ: {avg_mongo_time:.4f}—Å, –°—Ç–¥. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: {std_mongo_time:.4f}—Å")
    print(f"–û–±—â–µ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ PostgreSQL: {avg_mongo_time/avg_pg_time:.2f}x")

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
performance_results = {
    'comparison_time': datetime.now().isoformat(),
    'mongo_available': mongo_available,
    'weight_tests': {
        'weights': test_weights,
        'postgresql_times': postgres_times,
        'mongodb_times': mongodb_times if mongo_available else []
    },
    'statistics': {
        'postgresql_avg': avg_pg_time,
        'postgresql_std': std_pg_time,
        'mongodb_avg': avg_mongo_time if mongo_available else 0,
        'mongodb_std': std_mongo_time if mongo_available else 0
    }
}

with open('data/05_performance_results.json', 'w', encoding='utf-8') as f:
    json.dump(performance_results, f, ensure_ascii=False, indent=2)

print("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ data/05_performance_results.json")

if mongo_client:
    mongo_client.close()
